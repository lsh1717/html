<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-5.6.xsd">

    <!-- ======================= ë³´ì•ˆ ê·œì¹™ ======================= -->
    <security:http auto-config="true" use-expressions="true">

        <!-- ë¡œê·¸ì¸ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥ -->
        <security:intercept-url pattern="/login/login" access="permitAll"/>
        <security:intercept-url pattern="/login/register" access="permitAll"/>
        <security:intercept-url pattern="/user/bookList" access="permitAll"/>
        <security:intercept-url pattern="/user/bookDetail/**" access="permitAll"/>
        <security:intercept-url pattern="/" access="permitAll"/>

        <!-- ðŸ›’ ìž¥ë°”êµ¬ë‹ˆ / ì£¼ë¬¸ : ë¡œê·¸ì¸ ì•ˆ í•´ë„ ì ‘ê·¼ ê°€ëŠ¥ -->
        <security:intercept-url pattern="/cart/**" access="permitAll"/>
        <security:intercept-url pattern="/order/**" access="permitAll"/>

        <!-- ê´€ë¦¬ìž ì „ìš© -->
        <security:intercept-url pattern="/admin/**" access="hasRole('ADMIN')"/>

        <!-- ì¼ë°˜ ì‚¬ìš©ìž -->
        <security:intercept-url pattern="/user/**" access="hasAnyRole('CUSTOMER','ADMIN')"/>

        <!-- ë§ˆì§€ë§‰ catch-all -->
        <security:intercept-url pattern="/**" access="isAuthenticated()"/>

        <!-- ë¡œê·¸ì¸ ì„¤ì • -->
        <security:form-login
                login-page="/login/login"
                authentication-failure-url="/login/login?error=true"
                username-parameter="username"
                password-parameter="password"
                authentication-success-handler-ref="loginSuccess"/>

        <!-- ì ‘ê·¼ ê±°ë¶€ í•¸ë“¤ëŸ¬ -->
        <security:access-denied-handler ref="accessDenied"/>

        <!-- ë¡œê·¸ì•„ì›ƒ -->
        <security:logout logout-url="/logout"
                         logout-success-url="/login/login?logout=true"
                         delete-cookies="JSESSIONID,cart"/>
    </security:http>

    <!-- ======================= Authentication Manager ======================= -->
    <security:authentication-manager>
        <security:authentication-provider user-service-ref="loginService">
            <security:password-encoder ref="bpe"/>
        </security:authentication-provider>
    </security:authentication-manager>

    <!-- ======================= Bean ì •ì˜ ======================= -->
    <!-- ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”ê¸° -->
    <bean id="bpe" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"/>

    <!-- (ì„ íƒ) ê¶Œí•œ ë§¤í¼: ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë¨. ì‚¬ìš©í•œë‹¤ë©´ prefix ê³µëž€ ìœ ì§€ -->
    <bean id="authorityMapper"
          class="org.springframework.security.core.authority.mapping.SimpleAuthorityMapper">
        <property name="convertToUpperCase" value="true"/>
        <property name="prefix" value=""/>
    </bean>

    <!-- ë¡œê·¸ì¸ ì„±ê³µ í•¸ë“¤ëŸ¬ -->
    <bean id="loginSuccess" class="login.CustomerLoginSuccessHandler"/>

    <!-- ì ‘ê·¼ ê±°ë¶€ í•¸ë“¤ëŸ¬ -->
    <bean id="accessDenied" class="login.CustomerLoginDeniedHandler"/>

</beans>